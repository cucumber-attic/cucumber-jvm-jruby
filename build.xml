<?xml version="1.0" encoding="UTF-8"?>
<project name="cucumber-jruby" xmlns:ivy="antlib:org.apache.ivy.ant" default="test">
    <import file="../build-common.xml"/>

    <target name="jarjar" depends="compile-main">
        <ivy:cachepath pathid="ivy.build-classpath" conf="build"/>
        <taskdef name="jarjar" classname="com.tonicsystems.jarjar.JarJarTask" classpathref="ivy.build-classpath"/>

        <jarjar jarfile="lib/cucumber-jruby-full.jar">
            <fileset dir="target/classes"/>
            <zipfileset src="${local.info.cukes.cucumber-core}"/>
            <zipfileset src="${cache.info.cukes.gherkin}"/>
            <zipfileset src="${cache.com.thoughtworks.xstream.xstream}"/>
            <zipfileset src="${cache.com.googlecode.java-diff-utils.diffutils}"/>
            <zipfileset src="${cache.com.google.code.gson.gson}"/>
        </jarjar>
    </target>

    <target name="packages" depends="jar,jarjar"/>

    <target name="cli-test" depends="jarjar">
        <fail unless="env.JRUBY_HOME">You must define GROOVY_HOME in your shell</fail>
        <exec executable="${env.JRUBY_HOME}/bin/jruby">
            <arg file="bin/cucumber-jvm"/>
            <arg value="--glue"/>
            <arg file="src/test/resources"/>
            <arg file="src/test/resources"/>
        </exec>
    </target>

    <target name="gpg" depends="-gpg-default,jarjar,cli-test">
        <exec command="gpg">
            <arg value="-ab"/>
            <arg file="target/artifacts/jars/cucumber-jruby-full.jar"/>
        </exec>
    </target>

    <target name="publish-internet" depends="publish-nexus,publish-gem" />

    <target name="gpg" depends="jarjar">
        <echo>TODO: Package and push gem</echo>
    </target>

</project>
